<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Web Mania (穩定修復版)</title>
    <style>
        /* === 1. 介面設定 === */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            color: white;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('爆氣.jpg'); /* 你的背景圖 */
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: -1;
        }

        /* === 2. UI 層 (分數 + 滑桿) === */
        .ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            text-shadow: 0 0 5px black;
        }
        .score-board { font-size: 24px; color: #ffeb3b; }
        .combo-board { font-size: 40px; font-weight: bold; color: #00d2ff; margin-top: 10px;}
        
        /* 速度控制區 */
        .speed-control {
            margin-top: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
        }

        /* === 3. 遊戲區 === */
        .game-area {
            width: 400px;
            height: 100vh;
            display: flex;
            position: relative;
            background: rgba(0, 0, 0, 0.6);
            border-left: 4px solid #fff;
            border-right: 4px solid #fff;
        }

        .track {
            flex: 1;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            display: flex;
            justify-content: center;
        }
        .track:last-child { border-right: none; }

        .hit-line {
            position: absolute;
            bottom: 110px;
            width: 100%;
            height: 5px;
            background-color: #00d2ff;
            box-shadow: 0 0 15px #00d2ff;
            z-index: 5;
        }

        .pad {
            position: absolute;
            bottom: 10px;
            width: 80%;
            height: 80px;
            border: 3px solid #fff;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 36px;
            font-weight: 900;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            user-select: none;
            cursor: pointer;
        }
        .pad.active { transform: scale(0.95); background-color: #fff; color: #000; box-shadow: 0 0 25px white; }
        
        /* 每個軌道不同色 */
        .track:nth-child(2) .pad.active { box-shadow: 0 0 20px #ff4757; background-color: #ff4757; }
        .track:nth-child(3) .pad.active { box-shadow: 0 0 20px #2ed573; background-color: #2ed573; }
        .track:nth-child(4) .pad.active { box-shadow: 0 0 20px #eccc68; background-color: #eccc68; }
        .track:nth-child(5) .pad.active { box-shadow: 0 0 20px #5352ed; background-color: #5352ed; }

        /* === 4. 音符 === */
        .note {
            position: absolute;
            width: 80%;
            height: 25px;
            border-radius: 5px;
            top: -50px;
            background-color: #ff6b81;
            border: 2px solid #fff;
            box-shadow: 0 0 10px #ff6b81;
        }
        .track:nth-child(3) .note, .track:nth-child(4) .note { background-color: #7bed9f; box-shadow: 0 0 10px #7bed9f; }

        /* 判定文字 */
        .judge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 50px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 50;
            pointer-events: none;
        }
        .judge-text.show { opacity: 1; transform: translate(-50%, -60%); }

    </style>
</head>
<body>

    <div class="background"></div>

    <div class="ui-layer">
        <div class="score-board">Score: <span id="score">0</span></div>
        <div class="combo-board">Combo: <span id="combo">0</span></div>
        
        <div class="speed-control">
            <div>掉落時間: <span id="speed-text">2.0</span> 秒</div>
            <input type="range" id="speed-input" min="500" max="3000" value="2000" step="100">
            <div style="font-size: 12px; color: #aaa; margin-top: 5px;">(左快 - 右慢)</div>
        </div>
    </div>

    <div id="judge-display" class="judge-text">PERFECT</div>

    <div class="game-area">
        <div class="hit-line" id="hit-line"></div>

        <div class="track" id="track-0">
            <div class="pad" data-key="68">D</div>
        </div>
        <div class="track" id="track-1">
            <div class="pad" data-key="70">F</div>
        </div>
        <div class="track" id="track-2">
            <div class="pad" data-key="74">J</div>
        </div>
        <div class="track" id="track-3">
            <div class="pad" data-key="75">K</div>
        </div>
    </div>

    <audio data-key="68" src="痛標.mp3"></audio>
    <audio data-key="70" src="擺爛的擺爛.mp3"></audio>
    <audio data-key="74" src="爛船都有三分低.mp3"></audio>
    <audio data-key="75" src="都沒再問.mp3"></audio>

    <script>
        // === 全局變數 ===
        let score = 0;
        let combo = 0;
        let fallSpeed = 2000; // 預設 2秒掉到底

        const scoreEl = document.getElementById('score');
        const comboEl = document.getElementById('combo');
        const judgeEl = document.getElementById('judge-display');
        const hitLine = document.getElementById('hit-line');
        
        // 滑桿監聽
        const speedInput = document.getElementById('speed-input');
        const speedText = document.getElementById('speed-text');

        speedInput.addEventListener('input', function() {
            // 這裡只更新「掉落時間」的變數，絕對不要在這裡呼叫 setInterval！
            fallSpeed = parseInt(this.value);
            speedText.innerText = (fallSpeed / 1000).toFixed(1);
        });

        const keyTrackMap = { 68: 0, 70: 1, 74: 2, 75: 3 };

        // === 1. 產生音符 ===
        function spawnNote() {
            const randomTrack = Math.floor(Math.random() * 4);
            const track = document.getElementById(`track-${randomTrack}`);
            
            const note = document.createElement('div');
            note.classList.add('note');
            track.appendChild(note);

            // 這裡使用 fallSpeed 變數
            const animation = note.animate(
                [
                    { top: '-50px' },
                    { top: '110vh' }
                ],
                {
                    duration: fallSpeed, // 使用滑桿控制的速度
                    easing: 'linear'
                }
            );

            // 動畫結束後的處理 (Miss)
            animation.onfinish = () => {
                if (note.isConnected) {
                    combo = 0;
                    updateUI();
                    showJudge("MISS", "#ff5252");
                    note.remove();
                }
            };
        }

        // === 2. 判定邏輯 ===
        function checkHit(keyCode) {
            const trackIndex = keyTrackMap[keyCode];
            if (trackIndex === undefined) return;

            const track = document.getElementById(`track-${trackIndex}`);
            const notes = track.querySelectorAll('.note');
            const lineRect = hitLine.getBoundingClientRect();
            
            let hit = false;

            // 檢查所有音符
            notes.forEach(note => {
                const noteRect = note.getBoundingClientRect();
                const distance = Math.abs(noteRect.top - lineRect.top);

                // 距離小於 60px 算判定成功
                if (distance < 60) {
                    hit = true;
                    score += 100 + (combo * 10);
                    combo++;
                    showJudge("PERFECT", "#ffeb3b");
                    note.remove(); // 移除音符
                }
            });

            if (!hit && notes.length > 0) {
                // 這裡可以寫按錯扣分，暫時先不寫
            }

            updateUI();
        }

        // === 3. 更新畫面 ===
        function updateUI() {
            scoreEl.innerText = score;
            comboEl.innerText = combo;
        }

        function showJudge(text, color) {
            judgeEl.innerText = text;
            judgeEl.style.color = color;
            judgeEl.classList.add('show');
            setTimeout(() => judgeEl.classList.remove('show'), 200);
        }

        // === 4. 輸入監聽 ===
        function handleInput(keyCode) {
            const key = document.querySelector(`.pad[data-key="${keyCode}"]`);
            const audio = document.querySelector(`audio[data-key="${keyCode}"]`);
            
            if (key) {
                key.classList.add('active');
                setTimeout(() => key.classList.remove('active'), 100);
                checkHit(keyCode);
            }
            if (audio) {
                audio.currentTime = 0;
                audio.play();
            }
        }

        window.addEventListener('keydown', e => handleInput(e.keyCode));
        
        document.querySelectorAll('.pad').forEach(p => {
            p.addEventListener('click', function() {
                handleInput(this.getAttribute('data-key'));
            });
        });

        // === 5. 遊戲迴圈 (關鍵！) ===
        // 我們只設定一個計時器，固定 0.4 秒產生一個
        // 千萬不要把這個放進 input 事件裡！
        setInterval(spawnNote, 400);

    </script>
</body>
</html>