<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>痛飆 Mania (爆氣落下)</title>
    <style>
        /* === 1. 介面設定 === */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            color: white;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 50%;
            background-image: url('爆氣.jpg'); /* 背景圖 */
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: -1;
        }

        /* === 2. 分數與連擊顯示 === */
        .ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            text-shadow: 0 0 5px black;
        }
        .score-board { font-size: 24px; color: #ffeb3b; }
        .combo-board { font-size: 40px; font-weight: bold; color: #00d2ff; margin-top: 10px;}

        /* === 3. 遊戲區 === */
        .game-area {
            width: 400px;
            height: 100vh;
            display: flex;
            position: relative;
            background: rgba(0, 0, 0, 0.6);
            border-left: 4px solid #fff;
            border-right: 4px solid #fff;
        }

        .track {
            flex: 1;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            display: flex;
            justify-content: center;
        }
        .track:last-child { border-right: none; }

        /* 判定線 */
        .hit-line {
            position: absolute;
            bottom: 110px; /* 重要：這個高度是我們判定的基準 */
            width: 100%;
            height: 5px;
            background-color: #00d2ff;
            box-shadow: 0 0 15px #00d2ff;
            z-index: 5;
        }

        /* 按鍵 */
        .pad {
            position: absolute;
            bottom: 10px;
            width: 80%;
            height: 80px;
            border: 3px solid #fff;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 36px;
            font-weight: 900;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .pad.active { transform: scale(0.95); background-color: #fff; color: #000; box-shadow: 0 0 25px white; }

        /* === 4. 音符與判定特效 === */
        .note {
            position: absolute;
            width: 80%;
            height: 25px;
            border-radius: 5px;
            top: -50px;
            background-color: #ff6b81;
            border: 2px solid #fff;
            /* 改用 JS 控制掉落，方便判定位置 */
        }
        .track:nth-child(3) .note, .track:nth-child(4) .note { background-color: #7bed9f; }

        /* 判定文字 (Perfect / Miss) */
        .judge-text {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 50;
        }
        .judge-text.show { opacity: 1; transform: translate(-50%, -60%); } /* 往上飄一點 */

    </style>
</head>
<body>

    <div class="background"></div>

    <div class="ui-layer">
        <div class="score-board">Score: <span id="score">0</span></div>
        <div class="combo-board">Combo: <span id="combo">0</span></div>
    </div>

    <div id="judge-display" class="judge-text">PERFECT</div>

    <div class="game-area">
        <div class="hit-line" id="hit-line"></div>

        <div class="track" id="track-0"><div class="pad" data-key="68">D</div></div>
        <div class="track" id="track-1"><div class="pad" data-key="70">F</div></div>
        <div class="track" id="track-2"><div class="pad" data-key="74">J</div></div>
        <div class="track" id="track-3"><div class="pad" data-key="75">K</div></div>
    </div>

    <audio data-key="68" src="痛標.mp3"></audio>
    <audio data-key="70" src="擺爛的擺爛.mp3"></audio>
    <audio data-key="74" src="爛船都有三分低.mp3"></audio>
    <audio data-key="75" src="都沒再問.mp3"></audio>

    <script>
        // === 變數設定 ===
        let score = 0;
        let combo = 0;
        const scoreEl = document.getElementById('score');
        const comboEl = document.getElementById('combo');
        const judgeEl = document.getElementById('judge-display');
        const hitLine = document.getElementById('hit-line');

        // 定義按鍵對應的軌道索引 (D=0, F=1, J=2, K=3)
        const keyTrackMap = { 68: 0, 70: 1, 74: 2, 75: 3 };

        // === 1. 核心判定功能 ===
        function checkHit(keyCode) {
            // 1. 找出是哪一條軌道
            const trackIndex = keyTrackMap[keyCode];
            if (trackIndex === undefined) return; // 按錯鍵不管

            const track = document.getElementById(`track-${trackIndex}`);
            // 找出這條軌道上所有的音符
            const notes = track.querySelectorAll('.note');

            // 取得判定線的 Y 軸位置 (在螢幕上的高度)
            const lineRect = hitLine.getBoundingClientRect();
            const lineY = lineRect.top;

            let hitSomething = false;

            // 2. 檢查每一個音符的位置
            notes.forEach(note => {
                const noteRect = note.getBoundingClientRect();
                const noteY = noteRect.top;

                // 3. 計算距離：音符高度 - 判定線高度 (取絕對值)
                const distance = Math.abs(noteY - lineY);

                // 判定範圍：距離在 60px 以內算 Perfect
                if (distance < 60) {
                    // === 判定成功！ ===
                    hitSomething = true;
                    
                    // 加分邏輯
                    score += 100 + (combo * 10);
                    combo++;
                    
                    // 顯示特效
                    showJudge("PERFECT", "#ffeb3b");
                    
                    // 移除音符
                    note.remove();
                }
            });

            // 如果按了鍵但沒有按到任何音符 -> Miss (斷連擊)
            // 這裡為了簡單，我們先不嚴格扣分，只處理斷連擊
            /*
            if (!hitSomething && notes.length > 0) {
                 combo = 0;
                 showJudge("MISS", "#ff5252");
            }
            */

            updateUI();
            return hitSomething; // 回傳是否有按到
        }

        // === UI 更新 ===
        function updateUI() {
            scoreEl.innerText = score;
            comboEl.innerText = combo;
        }

        function showJudge(text, color) {
            judgeEl.innerText = text;
            judgeEl.style.color = color;
            judgeEl.classList.add('show');
            
            // 0.2秒後消失
            setTimeout(() => {
                judgeEl.classList.remove('show');
            }, 200);
        }

        // === 2. 按鍵與聲音 (結合判定) ===
        function handleInput(keyCode) {
            const audio = document.querySelector(`audio[data-key="${keyCode}"]`);
            const key = document.querySelector(`.pad[data-key="${keyCode}"]`);

            if (!key) return;

            // 視覺特效 (按鈕發光)
            key.classList.add('active');
            setTimeout(() => key.classList.remove('active'), 100);

            // 執行判定！
            const isHit = checkHit(keyCode);

            // 如果判定成功，或者是單純想發出聲音
            if (audio) {
                audio.currentTime = 0;
                audio.play();
            }
        }

        window.addEventListener('keydown', e => handleInput(e.keyCode));

        // 滑鼠點擊支援
        document.querySelectorAll('.pad').forEach(pad => {
            pad.addEventListener('click', function() {
                handleInput(this.getAttribute('data-key'));
            });
        });

        // === 3. 掉落系統 (改用 JS 動畫以配合判定) ===
        function spawnNote() {
            const randomTrackIndex = Math.floor(Math.random() * 4);
            const track = document.getElementById(`track-${randomTrackIndex}`);

            const note = document.createElement('div');
            note.classList.add('note');
            track.appendChild(note);

            // 使用 Web Animations API 讓它掉落 (這樣寫效能比較好)
            // 2000ms = 2秒掉到底
            const animation = note.animate(
                [
                    { top: '-50px' },
                    { top: '110vh' }
                ],
                {
                    duration: 2000, 
                    easing: 'linear'
                }
            );

            // 當動畫結束 (掉出螢幕)
            animation.onfinish = () => {
                // 如果音符還在 (沒被按掉)，代表漏接了 -> Miss
                if (note.isConnected) {
                    combo = 0; // 斷連擊
                    updateUI();
                    showJudge("MISS", "#ff5252");
                    note.remove();
                }
            };
        }

        // 每 0.5 秒掉一個
        setInterval(spawnNote, 500);

    </script>

</body>
</html>